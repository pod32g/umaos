#!/usr/bin/env bash
set -euo pipefail

log() {
  printf '[UmaOS Steam Root] %s\n' "$*"
}

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  log "This helper must run as root."
  exit 1
fi

if command -v steam >/dev/null 2>&1; then
  log "Steam is already installed."
  echo "Umazing!"
  exit 0
fi

enable_multilib() {
  local conf="/etc/pacman.conf"
  local tmp

  [[ -f "$conf" ]] || return 1
  tmp="$(mktemp)"

  awk '
    BEGIN {
      in_multilib = 0
      enabled_multilib = 0
      enabled_include = 0
    }
    {
      line = $0
      if (line ~ /^[[:space:]]*#?[[:space:]]*\[multilib\][[:space:]]*$/) {
        print "[multilib]"
        in_multilib = 1
        enabled_multilib = 1
        next
      }
      if (in_multilib == 1 && line ~ /^[[:space:]]*#?[[:space:]]*Include[[:space:]]*=[[:space:]]*\/etc\/pacman\.d\/mirrorlist[[:space:]]*$/) {
        print "Include = /etc/pacman.d/mirrorlist"
        enabled_include = 1
        in_multilib = 0
        next
      }
      if (in_multilib == 1 && line ~ /^[[:space:]]*\[[^]]+\][[:space:]]*$/) {
        in_multilib = 0
      }
      print line
    }
    END {
      if (enabled_multilib == 0) {
        print ""
        print "[multilib]"
        print "Include = /etc/pacman.d/mirrorlist"
      } else if (enabled_multilib == 1 && enabled_include == 0) {
        print "Include = /etc/pacman.d/mirrorlist"
      }
    }
  ' "$conf" > "$tmp"

  mv "$tmp" "$conf"
}

log "Ensuring multilib is enabled..."
enable_multilib

log "Refreshing package database and installing Steam..."
pacman -Sy --noconfirm --needed steam

log "Steam installation complete."
echo "Umazing!"
